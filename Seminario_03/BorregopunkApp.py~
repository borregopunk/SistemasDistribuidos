#############################################################################
##@Autor: Pablo Borrego Gutierrez                                          ##
##@Ejercicio: Seminario 3                                                  ##
##@Titulo: Aplicacion con la API de Twitter y flask                        ##
#############################################################################

#! /usr/bin/env python3

#<-------># IMPORTS #<------->#
import twitter
import io
import json
from flask import Flask, render_template
from flask.ext.googlemaps import GoogleMaps
from flask.ext.googlemaps import Map
from funciones.Funciones import oauth_login
from funciones.Funciones import save_json

#<-------># Autenticacion #<------->#
miUsuario = oauth_login()

#<-------># Variables #<------->#
app = Flask(__name__)
GoogleMaps(app)
q = raw_input('Introduzca la palabra para buscar: ')
search_results = twitter_api.search.tweets(q=q, count=10000)

#<-------># App #<------->#
save_json('tweets', search_results)
tweets = json.loads(open('tweets.json').read())

coordenadas = []

for tweet in tweets["statuses"]:
	if tweet["coordinates"] is not None: 
		coordenadas+="(",(tweet["geo"]["coordinates"][0],tweet["geo"]["coordinates"][1]),")"

for marker in coordenadas: 
	coordenadas.remove("(")	
	coordenadas.remove(")")

@app.route("/")
def mapview():
	mymap = Map(
	    identifier="view-side",
	    lat=40.416135, 
	    lng=-3.699449,
	    markers=coordenadas,
	    style="height:500px;width:1200px;margin:0;",
	    zoom = 5
	) 
	return render_template('template2.html', mymap=mymap)

if __name__ == "__main__":
	app.run()
